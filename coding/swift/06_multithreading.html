
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Multithreading &#8212; Z-Notes</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet" />
  <link href="../../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/css/theme_overrides.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/default.js"></script>
    <script src="../../_static/wavedrom.min.js"></script>
    <link rel="shortcut icon" href="../../_static/favicon.png"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="NS Classes" href="07_nsclasses.html" />
    <link rel="prev" title="Control Flow" href="05_controlflow.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    

<a class="navbar-brand" href="../../index.html">
  <img src="../../_static/logo.svg" class="logo" alt="logo">
</a>


    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../os/index.html">
  OS
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../tools/index.html">
  Tools
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../index.html">
  Coding
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../computerscience/index.html">
  Computerscience
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../hw/index.html">
  Hardware
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../multimedia/index.html">
  Multimedia
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../security/index.html">
  Security
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../../about/index.html">
  About
 </a>
</li>

    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/tschinz/znotes" rel="noopener" target="_blank" title="GitHub">
            <span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="https://twitter.com/tschinz" rel="noopener" target="_blank" title="Twitter">
            <span><i class="fab fa-twitter-square"></i></span>
            <label class="sr-only">Twitter</label>
          </a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="container-xl">
      <div class="row">
          
            
            <!-- Only show if we have sidebars configured, else just a small margin  -->
            <div class="col-12 col-md-3 bd-sidebar"><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Don't panic, search" aria-label="Don't panic, search" autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <p class="caption">
 <span class="caption-text">
  Content
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="01_basics.html">
   Basics
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02_mvc.html">
   Programming Concepts
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03_properties.html">
   Properties
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="04_datastructures_methods.html">
   Data Structures &amp; Methods
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05_controlflow.html">
   Control Flow
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Multithreading
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="07_nsclasses.html">
   NS Classes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="081_uielements.html">
   UI Elements
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="08_views.html">
   Views
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="09_other.html">
   Other
  </a>
 </li>
</ul>

  </div>
</nav>
            </div>
            
          

          
          <div class="d-none d-xl-block col-xl-2 bd-toc">
            
              
              <div class="toc-item">
                
<div class="tocsection onthispage pt-5 pb-3">
    <i class="fas fa-list"></i> On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#queue">
   Queue
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#main-queue-serial-queue">
     Main queue (serial queue)
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#other-queues">
     Other queues
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#execute-a-function-on-another-queue">
       Execute a function on another queue
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#quality-of-service">
       Quality of Service
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#create-serial-queue">
       Create serial queue
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#do-something-in-the-future">
   Do something in the future
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#other-things">
   Other Things
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#multithreading-ios-api">
   Multithreading iOS API
  </a>
 </li>
</ul>

</nav>
              </div>
              
              <div class="toc-item">
                

<div class="tocsection editthispage">
    <a href="https://github.com/tschinz/znotes/edit/master/source/coding/swift/06_multithreading.rst">
        <i class="fas fa-pencil-alt"></i> Edit this page
    </a>
</div>

              </div>
              
            
          </div>
          

          
          
            
          
          <main class="col-12 col-md-9 col-xl-7 py-md-5 pl-md-5 pr-md-4 bd-content" role="main">
              
              <div>
                
  <div class="section" id="multithreading">
<h1>Multithreading<a class="headerlink" href="#multithreading" title="Permalink to this headline">¶</a></h1>
<div class="section" id="queue">
<h2>Queue<a class="headerlink" href="#queue" title="Permalink to this headline">¶</a></h2>
<p>Multithreading is mostly about “queues” in iOS. Function (usually
closures) are lined up in a queue. The those functions are pulled off
the queue and executed on an associated thread.</p>
<div class="section" id="main-queue-serial-queue">
<span id="id1"></span><h3>Main queue (serial queue)<a class="headerlink" href="#main-queue-serial-queue" title="Permalink to this headline">¶</a></h3>
<p>All UI activity <strong>MUST</strong> occur <strong>only</strong> on this queue. Also all NON-UI
activity that is all time consuming must <strong>NOT</strong> occur on that queue. We
want the UI to be responsive! Functions are pulled off and worked on in
the main queue only when it’s quiet. All normal code will be happen in
the main queue.</p>
<div class="highlight-swift notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nv">mainQ</span><span class="p">:</span> <span class="n">dispatch_queue_t</span> <span class="p">=</span> <span class="n">dispatch_get_main_queue</span><span class="p">()</span>
<span class="kd">let</span> <span class="nv">mainQ</span><span class="p">:</span> <span class="bp">NSOperationQueue</span> <span class="p">=</span> <span class="bp">NSOperationQueue</span><span class="p">.</span><span class="n">mainQueue</span><span class="p">()</span> <span class="c1">// for Object oriented API</span>

<span class="n">dispatch_async</span><span class="p">(</span><span class="n">not</span> <span class="n">the</span> <span class="n">mainQueue</span><span class="p">){</span>
  <span class="c1">// do something that might blok or tkaes a while</span>
  <span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_main_queue</span><span class="p">())</span> <span class="p">{</span>
    <span class="c1">// call UI Functions with the result of the above</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="other-queues">
<h3>Other queues<a class="headerlink" href="#other-queues" title="Permalink to this headline">¶</a></h3>
<p>iOS are creating those queue as needed.</p>
<div class="section" id="execute-a-function-on-another-queue">
<h4>Execute a function on another queue<a class="headerlink" href="#execute-a-function-on-another-queue" title="Permalink to this headline">¶</a></h4>
<div class="highlight-swift notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nv">queue</span> <span class="n">dispatch_queue_t</span> <span class="p">=</span> <span class="p">&lt;</span><span class="kr">get</span> <span class="n">the</span> <span class="n">queue</span> <span class="n">you</span> <span class="n">want</span><span class="p">....</span><span class="o">&gt;</span>
<span class="n">dispatch_async</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span> <span class="p">{</span><span class="cm">/* fo what you want to do here */</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="quality-of-service">
<h4>Quality of Service<a class="headerlink" href="#quality-of-service" title="Permalink to this headline">¶</a></h4>
<p>Most non-main-queue work will happen on a concurrent queue with a
certain quality of service.</p>
<div class="highlight-swift notranslate"><div class="highlight"><pre><span></span><span class="n">QOS_CLASS_USER_INTERACTIVE</span> <span class="c1">// quick and high priority</span>
<span class="n">QOS_CLASS_USER_INITIATED</span>   <span class="c1">// high priority, might take time</span>
<span class="n">QOS_CLASS_UTILITY</span>          <span class="c1">// long running</span>
<span class="n">QOS_CLASS_BACKGROUND</span>       <span class="c1">// user not concerned with this (prefetching etc.)</span>
<span class="kd">let</span> <span class="nv">qos</span> <span class="p">=</span> <span class="n">INT</span><span class="p">(&lt;</span><span class="n">one</span> <span class="n">of</span> <span class="n">the</span> <span class="n">above</span><span class="p">&gt;.</span><span class="n">value</span><span class="p">)</span> <span class="c1">// historical reasons</span>
<span class="kd">let</span> <span class="nv">queue</span> <span class="p">=</span> <span class="n">dispatch_get_global_queue</span><span class="p">(</span><span class="n">qos</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>These queues can be used for work that won’t block the main queue.</p>
</div>
<div class="section" id="create-serial-queue">
<h4>Create serial queue<a class="headerlink" href="#create-serial-queue" title="Permalink to this headline">¶</a></h4>
<p>If you need serialization. E.g. downloading a bunch of things from a
certain website but you don’t want to deluge that website, so you queue
the request up serially <em>OR</em> maybe the things you are doing depend on
each other in a serial fashion.</p>
<div class="highlight-swift notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nv">serialQ</span> <span class="p">=</span> <span class="n">dispatch_queue_create</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">,</span> <span class="n">DISPATCH_QUEUE_SERIAL</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="do-something-in-the-future">
<h2>Do something in the future<a class="headerlink" href="#do-something-in-the-future" title="Permalink to this headline">¶</a></h2>
<p>You almost always <code class="docutils literal notranslate"><span class="pre">dispatch_after</span></code> into the main queue. All other
queues are anyway concurrent and can’t guarantee time delay’s.</p>
<div class="highlight-swift notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nv">delayInSeconds</span> <span class="p">=</span> <span class="mf">25.0</span>
<span class="kd">let</span> <span class="nv">delay</span> <span class="p">=</span> <span class="nb">Int64</span><span class="p">(</span><span class="n">delayInSeconds</span><span class="o">*</span><span class="nb">Double</span><span class="p">(</span><span class="n">NSEC_PER_MSEC</span><span class="p">))</span>
<span class="kd">let</span> <span class="nv">dispatchTime</span> <span class="p">=</span> <span class="n">dispatch_time</span><span class="p">(</span><span class="n">DISPATCH_TIME_NOW</span><span class="p">,</span> <span class="n">delay</span><span class="p">)</span> <span class="c1">// adds delay to now</span>
<span class="n">dispatch_after</span><span class="p">(</span><span class="n">dispatchTime</span><span class="p">,</span> <span class="n">dispatch_get_main_queue</span><span class="p">())</span> <span class="p">{</span>
  <span class="c1">// do something on the main queue 25 seconds from now</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="other-things">
<h2>Other Things<a class="headerlink" href="#other-things" title="Permalink to this headline">¶</a></h2>
<p>There’s a lot more Multithreading stuff.</p>
<ul class="simple">
<li><p>locking</p></li>
<li><p>protect critical sections</p></li>
<li><p>readers and writers</p></li>
<li><p>synchronous dispatch</p></li>
<li><p>etc….</p></li>
</ul>
</div>
<div class="section" id="multithreading-ios-api">
<h2>Multithreading iOS API<a class="headerlink" href="#multithreading-ios-api" title="Permalink to this headline">¶</a></h2>
<p>Many API are multithreaded and wont work on the main queue. Theirs works
need to be dispached elsewhere.</p>
<div class="highlight-swift notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nv">session</span> <span class="p">=</span> <span class="n">NSURLSESSION</span><span class="p">(</span><span class="bp">NSURLSessionConfiguration</span><span class="p">.</span><span class="n">defaultSessionConfiguration</span><span class="p">())</span>
<span class="k">if</span> <span class="kd">let</span> <span class="nv">url</span> <span class="p">=</span> <span class="bp">NSURL</span><span class="p">(</span><span class="s">&quot;http://url&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nv">request</span> <span class="p">=</span> <span class="bp">NSURLRequest</span><span class="p">(</span><span class="n">URL</span><span class="p">:</span><span class="n">url</span><span class="p">)</span>
    <span class="c1">// not working</span>
    <span class="kd">let</span> <span class="nv">task</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">downloadTaskWithRequest</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="n">localURL</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
        <span class="c1">// Here you can&#39;r do UI Stuff with the result of the download!!</span>
    <span class="p">}</span>
    <span class="c1">// working</span>
    <span class="kd">let</span> <span class="nv">task</span> <span class="p">=</span> <span class="n">session</span><span class="p">.</span><span class="n">downloadTaskWithRequest</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span> <span class="p">(</span><span class="n">localURL</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span> <span class="k">in</span>
        <span class="n">dispatch_async</span><span class="p">(</span><span class="n">dispatch_get_main_queue</span><span class="p">())</span> <span class="p">{</span>
            <span class="c1">// Here you can do UI related stuff</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="n">task</span><span class="p">.</span><span class="n">reasume</span><span class="p">()</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the above example the UI code has been dispatched back to the main
queue. But understand that the code might run <strong>MINUTES</strong> after the
request is fired off. The user might have long ago given up on whatever
was being fetched.</p>
<p><a class="search-tag reference external" href="/search.html?q=coding&amp;check_keywords=yes&amp;area=default">coding</a>
<a class="search-tag reference external" href="/search.html?q=swift&amp;check_keywords=yes&amp;area=default">swift</a></p>
</div>
</div>

    <script type="text/javascript">
        function init() {
            WaveDrom.ProcessAll();
        }
        window.onload = init;
    </script>

              </div>
              
              
          </main>
          

      </div>
    </div>
    
  <script src="../../_static/js/index.1c5a1a01449ed65a7b51.js"></script>


    
    <!-- Google Analytics -->
    <script>
      window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
      ga('create', 'UA-20699788-1', 'auto');
      ga('set', 'anonymizeIp', true);
      ga('send', 'pageview');
    </script>
    <script async src='https://www.google-analytics.com/analytics.js'></script>
    <!-- End Google Analytics -->
    <footer class="footer mt-5 mt-md-0">
  <div class="container">
    
    <div class="footer-item">
      

<a class="navbar-brand" href="../../index.html">
  <img src="../../_static/logo.svg" class="logo" alt="logo">
</a>


    </div>
    
    <div class="footer-item">
      <p class="copyright">
    &copy; Copyright 2004-2021, tschinz.<br/>
</p>
    </div>
    
    <div class="footer-item">
      <!-- This will display the version of the docs -->

    </div>
    
  </div>
</footer>
  </body>
</html>